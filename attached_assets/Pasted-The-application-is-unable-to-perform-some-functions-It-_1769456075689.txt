The application is unable to perform some functions:

ğŸ”¸ It cannot fetch some offers for certain links. I think it does not use offers_secondary.

ğŸ”¸ It is true that some links do not respond to the API because some products are not supported, but the app must fetch the image and title using web scraping like in the first Python code (the image is always fetched via web scraping, and the title only if the API fails).

ğŸ”¸ The link input field does not recognize AliExpress links inside normal text.

ğŸ”¸ The product details are not complete like in the second Python code.

ğŸ”¸ In the settings, the language and modes do not respond.

ğŸ”¸ The offer buttons work correctly, but they do not look like real buttons to the user; their design must be updated.

âœ… First Python code: it contains the functions for offers, title, and image: 
import os, re, hmac, hashlib, requests, time, json
from datetime import datetime
from bs4 import BeautifulSoup
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from functools import lru_cache
from cachetools import TTLCache

# ----------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -----------
APP_KEY, APP_SECRET = os.getenv('APP_KEY'), os.getenv('APP_SECRET')
TRACKING_ID, TOKEN = os.getenv('TRACKING_ID'), os.getenv('TELEGRAM_TOKEN')
API_URL = "https://api-sg.aliexpress.com/sync"

# ----------- ÙƒØ§Ø´ Ù…Ø¹ TTL -----------
cache = TTLCache(maxsize=1000, ttl=300)

# ----------- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -----------
@lru_cache(maxsize=100)
def extract_product_id(text):
    try:
        if not any(domain in text for domain in ['aliexpress.com', 'alix.live', 's.click.aliexpress.com']):
            return None
        session = requests.Session()
        response = session.head(text, allow_redirects=True, timeout=10)
        final_url = response.url
    except:
        final_url = text

    patterns = [
        r'[?&]productIds=(\d+)',
        r'[?&]productId=(\d+)',
        r'/item/(\d+)\.(?:html|htm)',
        r'/item/(\d+)(?:\?|$)',
        r'/product/(\d+)',
        r'/i/(\d+)',
        r'/p/[^/]+/index\.html[?&]productIds=(\d+)',
        r'/ssr/.*?[?&]productIds=(\d+)',
        r'/[a-z0-9]+\.html\?.*?productId(?:s)?=(\d+)',
    ]

    for pattern in patterns:
        match = re.search(pattern, final_url)
        if match:
            return match.group(1)
    return None

# ----------- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ -----------
def generate_api_signature(params, secret):
    param_string = ''.join([f"{k}{v}" for k, v in sorted(params.items())])
    return hmac.new(secret.encode('utf-8'), param_string.encode('utf-8'), hashlib.sha256).hexdigest().upper()

# ----------- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -----------
def generate_affiliate_links(product_id):
    cache_key = f"links_{product_id}"
    if cache_key in cache:
        return cache[cache_key]

    offers_primary = [
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª", f"https://m.aliexpress.com/p/coin-index/index.html?_immersiveMode=true&productIds={product_id}"),
        ("ğŸ’¥Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù†ØªØ¬", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=620"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Super Deals", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=562"),
        ("ğŸ’¥Ø¹Ø±Ø¶ ØªØ®ÙÙŠØ¶ Big Save", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=680"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=561"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø­ØªÙ…Ù„", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=504"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¨Ø§Ù†Ø¯Ù„ ", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=570"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„", f"https://www.aliexpress.com/ssr/300000512/BundleDeals2?&pha_manifest=ssr&productIds={product_id}")
    ]

    offers_secondary = [
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://m.aliexpress.com/p/coin-index/index.html?_immersiveMode=true&productIds={product_id}",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=620",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=562",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=680",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=561",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=504",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=570",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/ssr/300000512/BundleDeals2?&pha_manifest=ssr&productIds={product_id}",
    ]

    def try_generate_link(url_to_try):
        params = {
            "method": "aliexpress.affiliate.link.generate",
            "app_key": APP_KEY,
            "sign_method": "sha256",
            "timestamp": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S"),
            "v": "2.0",
            "format": "json",
            "tracking_id": TRACKING_ID,
            "promotion_link_type": "0",
            "source_values": url_to_try
        }
        params['sign'] = generate_api_signature(params, APP_SECRET)

        try:
            response = requests.get(API_URL, params=params, timeout=15)
            response.raise_for_status()
            data = response.json()
            result = data.get('aliexpress_affiliate_link_generate_response', {}).get('resp_result', {}).get('result', {})
            if result.get('promotion_links'):
                return result['promotion_links']['promotion_link'][0]['promotion_link']
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·: {e}")
        return None

    results = []
    for i, (name, primary_url) in enumerate(offers_primary):
        affiliate_link = try_generate_link(primary_url)
        if affiliate_link is None and i < len(offers_secondary):
            secondary_url = offers_secondary[i]
            affiliate_link = try_generate_link(secondary_url)
        if affiliate_link:
            results.append(f"{name}:\n{affiliate_link}")
        else:
            results.append(f"{name}:\nâŒ ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±")

    cache[cache_key] = results
    return results

# ----------- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… BeautifulSoup -----------
@lru_cache(maxsize=50)
def get_product_details(product_id):
    try:
        url = f"https://www.aliexpress.com/item/{product_id}.html"
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            "Accept-Language": "en-US,en;q=0.5",
        }

        response = requests.get(url, headers=headers, timeout=15)
        response.raise_for_status()
        soup = BeautifulSoup(response.content, 'html.parser')

        title = None
        title_element = soup.find('h1', {'class': 'product-title-text'})
        if title_element:
            title = title_element.get_text(strip=True)

        if not title:
            meta_title = soup.find('meta', {'property': 'og:title'})
            if meta_title:
                title = meta_title.get('content', '')

        if not title:
            title_element = soup.find('title')
            if title_element:
                title = title_element.get_text(strip=True)

        image_url = None
        image_element = soup.find('img', {'class': 'magnifier-image'})
        if image_element:
            image_url = image_element.get('src') or image_element.get('data-src')

        if not image_url:
            meta_image = soup.find('meta', {'property': 'og:image'})
            if meta_image:
                image_url = meta_image.get('content')

        if image_url and image_url.startswith('//'):
            image_url = f"https:{image_url}"

        return {
            'title': title.strip()[:255] if title else 'ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
            'image_url': image_url
        }
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬: {e}")
        return {'title': 'ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'image_url': None}

# ----------- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª -----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    start_text = "âš™ï¸Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ®ÙÙŠØ¶ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ØµÙŠÙ†ÙŠ Ø§Ù„Ø´Ù‡ÙŠØ± Aliexpress..."
    await update.message.reply_text(start_text)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text
    url_pattern = r'https?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'
    urls = re.findall(url_pattern, user_input)

    target_url = next((url for url in urls if any(domain in url for domain in ['aliexpress.com', 'alix.live', 's.click.aliexpress.com'])), None)
    if not target_url:
        await update.message.reply_text("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ§Ø¨Ø· Ù…Ù†ØªØ¬Ø§Øª Aliexpress ÙÙ‚Ø· ğŸ˜•")
        return

    try:
        product_id = extract_product_id(target_url)
        if not product_id:
            await update.message.reply_text("âŒ Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ aliexpress Ø§Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹")
            return

        await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶")
        product = get_product_details(product_id)
        links = generate_affiliate_links(product_id)

        response_text = f"ğŸ“¦ØªØ®ÙÙŠØ¶ Ø¹Ù„Ù‰:\n {product['title']}\n\n" + "\n\n".join(links) if product['title'] != 'ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' else "ğŸ“¦ ØªØ®ÙÙŠØ¶ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ AliExpress\n\n" + "\n\n".join(links)

        if product['image_url']:
            try:
                await update.message.reply_photo(photo=product['image_url'], caption=response_text, parse_mode="HTML")
            except:
                await update.message.reply_text(response_text)
        else:
            await update.message.reply_text(response_text)

    except Exception as e:
        print(f"Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ handle_message: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ")

# ----------- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª -----------
def main():
    application = Application.builder().token(TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    print("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
    application.run_polling()

if __name__ == '__main__':
    main()

    âœ…Second Python code: it contains the function for fetching product details: 
    import os, re, logging, hashlib, hmac, time, json
from datetime import datetime
from bs4 import BeautifulSoup
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
from functools import lru_cache
from cachetools import TTLCache
import requests

# ----------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -----------
APP_KEY, APP_SECRET = os.getenv('APP_KEY'), os.getenv('APP_SECRET')
TRACKING_ID, TOKEN = os.getenv('TRACKING_ID'), os.getenv('TELEGRAM_TOKEN')
API_URL = "https://api-sg.aliexpress.com/sync"

if not all([APP_KEY, APP_SECRET, TRACKING_ID, TOKEN]):
    raise EnvironmentError("âŒ Missing required environment variables")

# ----------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -----------
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ----------- ÙƒØ§Ø´ Ù…Ø¹ TTL -----------
cache = TTLCache(maxsize=1000, ttl=300)
product_info_cache = TTLCache(maxsize=500, ttl=600)  # ÙƒØ§Ø´ Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬

# ----------- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -----------
@lru_cache(maxsize=100)
def extract_product_id(text):
    try:
        if not any(domain in text for domain in ['aliexpress.com', 'alix.live', 's.click.aliexpress.com']):
            return None
        session = requests.Session()
        response = session.head(text, allow_redirects=True, timeout=10)
        final_url = response.url
    except:
        final_url = text

    patterns = [
        r'[?&]productIds=(\d+)',
        r'[?&]productId=(\d+)',
        r'/item/(\d+)\.(?:html|htm)',
        r'/item/(\d+)(?:\?|$)',
        r'/product/(\d+)',
        r'/i/(\d+)',
        r'/p/[^/]+/index\.html[?&]productIds=(\d+)',
        r'/ssr/.*?[?&]productIds=(\d+)',
        r'/[a-z0-9]+\.html\?.*?productId(?:s)?=(\d+)',
    ]

    for pattern in patterns:
        match = re.search(pattern, final_url)
        if match:
            return match.group(1)
    return None

# ----------- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù„Ù„ØªÙØ§ØµÙŠÙ„ -----------
def generate_sign(params, app_secret):
    return hmac.new(app_secret.encode(), ''.join(f"{k}{v}" for k, v in sorted(params.items())).encode(), hashlib.sha256).hexdigest().upper()

# ----------- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù„Ù„Ø¹Ø±ÙˆØ¶ -----------
def generate_api_signature(params, secret):
    param_string = ''.join([f"{k}{v}" for k, v in sorted(params.items())])
    return hmac.new(secret.encode('utf-8'), param_string.encode('utf-8'), hashlib.sha256).hexdigest().upper()

# ----------- Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ API Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© -----------
def send_api_request_with_retry(all_params, max_retries=2):
    for attempt in range(max_retries):
        try:
            response = requests.post("https://api-sg.aliexpress.com/sync", data=all_params, timeout=10)
            if response.status_code != 200:
                if attempt < max_retries - 1: 
                    time.sleep(1)
                    continue
            data = response.json()
            if 'error_response' in data:
                if data['error_response'].get('code') == 'ApiCallLimit':
                    ban_time = 5 if '5 seconds' in data['error_response'].get('msg','') else 1
                    if attempt < max_retries - 1: 
                        time.sleep(ban_time + 0.5)
                        continue
                return data
            return data
        except requests.exceptions.Timeout:
            if attempt < max_retries - 1: 
                time.sleep(2)
                continue
        except Exception as e:
            if attempt < max_retries - 1: 
                time.sleep(1)
                continue
    return {'error_response': {'code': 'MaxRetriesExceeded', 'msg': 'ÙØ´Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª'}}

# ----------- ØªØ­Ø¶ÙŠØ± Ù…Ø¹Ù„Ù…Ø§Øª API Ù„Ù„ØªÙØ§ØµÙŠÙ„ -----------
def prepare_api_params(product_id):
    params = {
        'method': 'aliexpress.affiliate.productdetail.get',
        'app_key': APP_KEY,
        'sign_method': 'sha256',
        'timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),
        'format': 'json',
        'v': '2.0',
        'product_ids': product_id,
        'target_currency': 'USD',
        'target_language': 'EN',
        'tracking_id': TRACKING_ID
    }
    return {**params, 'sign': generate_sign(params, APP_SECRET)}

# ----------- ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ -----------
def parse_product_data(product_data):
    try:
        product = product_data['aliexpress_affiliate_productdetail_get_response']['resp_result']['result']['products'].get('product')
        if not product: 
            return {}
        p = product[0] if isinstance(product, list) else product
        sale_price = p.get('target_sale_price', p.get('app_sale_price', 'ØºÙŠØ± Ù…ØªÙˆÙØ±'))
        original_price = p.get('target_original_price', p.get('original_price', 'ØºÙŠØ± Ù…ØªÙˆÙØ±'))
        discount = p.get('target_discount', 'ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨')

        if discount == 'ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨' and original_price != 'ØºÙŠØ± Ù…ØªÙˆÙØ±' and sale_price != 'ØºÙŠØ± Ù…ØªÙˆÙØ±':
            try:
                original = float(str(original_price).replace('USD', '').replace('$', '').strip())
                sale = float(str(sale_price).replace('USD', '').replace('$', '').strip())
                if original > 0: 
                    discount = f"{((original - sale) / original) * 100:.1f}%"
            except: 
                pass

        shop_url = p.get('shop_url', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')
        if '/store/' in shop_url:
            try: 
                shop_url = f"https://m.aliexpress.com/store/{shop_url.split('/store/')[1].split('/')[0].split('?')[0]}?shopId={shop_url.split('/store/')[1].split('/')[0].split('?')[0]}"
            except: 
                pass

        return {
            'product_title': p.get('product_title', 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
            'target_sale_price': f"{sale_price} USD",
            'target_original_price': f"{original_price} USD",
            'target_discount': discount,
            'lastest_volume': p.get('lastest_volume', 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
            'shop_name': p.get('shop_name', 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
            'evaluate_rate': p.get('evaluate_rate', 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
            'shop_url': shop_url,
            'first_level_category_name': p.get('first_level_category_name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            'second_level_category_name': p.get('second_level_category_name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            'commission_rate': p.get('commission_rate', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            'product_id': extract_product_id_from_data(p)
        }
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬: {e}")
        return {}

def extract_product_id_from_data(product_data):
    try:
        product_url = product_data.get('product_url', '')
        if '/item/' in product_url:
            return product_url.split('/item/')[1].split('.')[0]
    except:
        pass
    return None

# ----------- ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ -----------
def format_product_message(info):
    return f"""ğŸ“¦ **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒØ§Ù…Ù„Ø©**
ğŸ›’ **Ø§Ù„Ø§Ø³Ù…:** {info['product_title']}
ğŸ’° **Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:** {info['target_sale_price']}
ğŸ·ï¸ **Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ:** {info['target_original_price']}
ğŸ **Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…:** {info['target_discount']}
ğŸ“Š **Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:** {info['lastest_volume']}
ğŸ“‚ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±:** 
ğŸª **Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±:** {info['shop_name']}
ğŸ“Š **Ù…Ø¹Ø¯Ù„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø±:** {info['evaluate_rate']}
ğŸ”— **Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±:** {info['shop_url']}
ğŸ“‚ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:**
   â€¢ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {info['first_level_category_name']}
   â€¢ Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©: {info['second_level_category_name']}
ğŸ’¡ **Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:** {info['commission_rate']}
â° *ØªÙ… Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙŠ: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}*"""

# ----------- ØªÙˆÙ„ÙŠØ¯ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø±ÙˆØ¶ -----------
def generate_affiliate_links(product_id):
    cache_key = f"links_{product_id}"
    if cache_key in cache:
        return cache[cache_key]

    offers_primary = [
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª", f"https://m.aliexpress.com/p/coin-index/index.html?_immersiveMode=true&productIds={product_id}"),
        ("ğŸ’¥Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù†ØªØ¬", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=620"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Super Deals", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=562"),
        ("ğŸ’¥Ø¹Ø±Ø¶ ØªØ®ÙÙŠØ¶ Big Save", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=680"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=561"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø­ØªÙ…Ù„", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=504"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¨Ø§Ù†Ø¯Ù„ ", f"https://www.aliexpress.com/item/{product_id}.html?sourceType=570"),
        ("ğŸ’¥Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„", f"https://www.aliexpress.com/ssr/300000512/BundleDeals2?&pha_manifest=ssr&productIds={product_id}")
    ]

    offers_secondary = [
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://m.aliexpress.com/p/coin-index/index.html?_immersiveMode=true&productIds={product_id}",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=620",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=562",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=680",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=561",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=504",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/item/{product_id}.html?sourceType=570",
        f"https://star.aliexpress.com/share/share.htm?redirectUrl=https://www.aliexpress.com/ssr/300000512/BundleDeals2?&pha_manifest=ssr&productIds={product_id}",
    ]

    def try_generate_link(url_to_try):
        params = {
            "method": "aliexpress.affiliate.link.generate",
            "app_key": APP_KEY,
            "sign_method": "sha256",
            "timestamp": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S"),
            "v": "2.0",
            "format": "json",
            "tracking_id": TRACKING_ID,
            "promotion_link_type": "0",
            "source_values": url_to_try
        }
        params['sign'] = generate_api_signature(params, APP_SECRET)

        try:
            response = requests.get(API_URL, params=params, timeout=15)
            response.raise_for_status()
            data = response.json()
            result = data.get('aliexpress_affiliate_link_generate_response', {}).get('resp_result', {}).get('result', {})
            if result.get('promotion_links'):
                return result['promotion_links']['promotion_link'][0]['promotion_link']
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·: {e}")
        return None

    results = []
    for i, (name, primary_url) in enumerate(offers_primary):
        affiliate_link = try_generate_link(primary_url)
        if affiliate_link is None and i < len(offers_secondary):
            secondary_url = offers_secondary[i]
            affiliate_link = try_generate_link(secondary_url)
        if affiliate_link:
            results.append(f"{name}:\n{affiliate_link}")
        else:
            results.append(f"{name}:\nâŒ ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±")

    cache[cache_key] = results
    return results

# ----------- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… BeautifulSoup -----------
@lru_cache(maxsize=50)
def get_product_details(product_id):
    try:
        url = f"https://www.aliexpress.com/item/{product_id}.html"
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            "Accept-Language": "en-US,en;q=0.5",
        }

        response = requests.get(url, headers=headers, timeout=15)
        response.raise_for_status()
        
        # Extract title and image from the page content directly if possible
        content = response.text
        
        title = None
        title_match = re.search(r'"subject":"([^"]+)"', content)
        if title_match:
            title = title_match.group(1)
        
        if not title:
            title_match = re.search(r'<title>(.*?)</title>', content)
            if title_match:
                title = title_match.group(1)

        image_url = None
        image_match = re.search(r'"imagePath":"([^"]+)"', content)
        if image_match:
            image_url = image_match.group(1)
            if not image_url.startswith('http'):
                image_url = f"https:{image_url}"
        
        if not image_url:
            image_match = re.search(r'og:image" content="([^"]+)"', content)
            if image_match:
                image_url = image_match.group(1)

        return {
            'title': title.strip()[:255] if title else 'ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
            'image_url': image_url
        }
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬: {e}")
        return {'title': 'ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'image_url': None}

# ----------- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª -----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    start_text = """Ù…Ø±Ø­Ø¨Ù‹Ø§! ğŸ‘‹ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ù…Ù†ØªØ¬ Ù…Ù† AliExpress Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„Ù‡ Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø­Ø©.

ğŸ“ **Ù…Ø«Ø§Ù„ Ù„Ù„Ø±Ø§Ø¨Ø·:**
https://www.aliexpress.com/item/1005001234567890.html

ğŸ¤– **Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:**
/start - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
/help - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"""
    await update.message.reply_text(start_text)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """ğŸ“š **ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
1. Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ù…Ù†ØªØ¬ Ù…Ù† AliExpress
2. Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
3. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ğŸ”— Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø­Ø©

ğŸ“ **Ø§Ù„Ù…ÙŠØ²Ø§Øª:**
â€¢ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„Ø®ØµÙ…ØŒ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§ØªØŒ Ø¥Ù„Ø®)
â€¢ Ø±ÙˆØ§Ø¨Ø· Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª
â€¢ Ø¹Ø¯Ø© Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª
â€¢ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ø§

âš ï¸ **Ù…Ù„Ø§Ø­Ø¸Ø©:** ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 'aliexpress.com'"""
    await update.message.reply_text(help_text)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    msg = update.message.text.strip()

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ AliExpress
    if not any(domain in msg for domain in ['aliexpress.com', 'alix.live', 's.click.aliexpress.com']):
        await update.message.reply_text("âš ï¸ ÙŠÙØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ù…Ù†ØªØ¬ ØµØ§Ù„Ø­ Ù…Ù† AliExpress ÙÙ‚Ø·.")
        return

    await update.message.reply_text("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…ØªÙˆÙØ±Ø©â€¦ â³")

    try:
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬
        product_id = extract_product_id(msg)
        if not product_id:
            await update.message.reply_text("âŒ ØªØ¹Ø°Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·.")
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† API
        params = prepare_api_params(product_id)
        data = send_api_request_with_retry(params, max_retries=3)

        if 'error_response' in data:
            if data['error_response'].get('code') == 'MaxRetriesExceeded':
                await update.message.reply_text("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
            else:
                await update.message.reply_text(f"âŒ Ø®Ø·Ø£ Ù…Ù† API: {data['error_response'].get('msg', 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}")
            return

        if not (info := parse_product_data(data)):
            await update.message.reply_text("âš ï¸ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±: AliExpress ØªØ±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬")
            return

        # ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§
        product_info_cache[f"info_{product_id}"] = info

        # Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± "Ø§Ù„Ø¹Ø±ÙˆØ¶"
        keyboard = [
            [InlineKeyboardButton("ğŸ”— Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶", callback_data=f"offers_{product_id}")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ Ø§Ù„Ø²Ø±
        await update.message.reply_text(
            format_product_message(info),
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ handle_message: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.")

async def handle_offers_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† callback_data
    product_id = query.data.replace("offers_", "")

    await query.edit_message_text(text="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø­Ø©...")

    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
        product_info = product_info_cache.get(f"info_{product_id}", {})
        product_title = product_info.get('product_title', 'Ù…Ù†ØªØ¬ AliExpress')

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø±ÙˆØ¶
        offers = generate_affiliate_links(product_id)

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
        product_details = get_product_details(product_id)

        # Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶
        response_text = f"ğŸ¯ **Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†ØªØ¬:** {product_title}\n\n"
        response_text += "\n\n".join(offers)
        response_text += f"\n\nğŸ“… *ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*"

        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
        if product_details.get('image_url'):
            try:
                await query.message.reply_photo(
                    photo=product_details['image_url'],
                    caption=response_text,
                    parse_mode="Markdown"
                )
            except:
                await query.message.reply_text(response_text, parse_mode="Markdown")
        else:
            await query.message.reply_text(response_text, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ handle_offers_callback: {e}")
        await query.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø±ÙˆØ¶.")

def main():
    logger.info("âœ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")

    try:
        # Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        app = Application.builder().token(TOKEN).build()

        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CommandHandler("help", help_command))

        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± "Ø§Ù„Ø¹Ø±ÙˆØ¶"
        app.add_handler(CallbackQueryHandler(handle_offers_callback, pattern="^offers_"))

        logger.info("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...")

        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
        app.run_polling(allowed_updates=Update.ALL_TYPES, drop_pending_updates=True)

    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")

if __name__ == '__main__':
    main()